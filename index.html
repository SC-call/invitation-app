<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- PWA Áõ∏Èóú meta Ê®ôÁ±§ -->
    <meta name="theme-color" content="#4285f4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ÂÅ•Ê™¢ÈÇÄÁ¥Ñ">
    <meta name="description" content="ÂÅ•Â∫∑Ê™¢Êü•ÈÇÄÁ¥ÑÁÆ°ÁêÜÁ≥ªÁµ± - ÊîØÊè¥Èõ¢Á∑öÊìç‰Ωú">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE0IDJINmEyIDIgMCAwIDAtMiAydjE2YTIgMiAwIDAgMCAyIDJoMTJhMiAyIDAgMCAwIDItMlY4eiIgZmlsbD0iIzQyODVmNCIvPgo8cG9seWxpbmUgcG9pbnRzPSIxNCwyIDE0LDggMjAsOCIgZmlsbD0iIzM0YTg1MyIvPgo8bGluZSB4MT0iMTYiIHkxPSIxMyIgeDI9IjgiIHkyPSIxMyIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxsaW5lIHgxPSIxNiIgeTE9IjE3IiB4Mj0iOCIgeTI9IjE3IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- CSS Âíå JS -->
    <link rel="stylesheet" href="style.css">
    <script src="script.js" defer></script>
    
    <title>ÂÅ•Ê™¢ÈÇÄÁ¥ÑÁ≥ªÁµ±</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ÂÅ•Ê™¢ÈÇÄÁ¥ÑÁ≥ªÁµ±</h1>
            <p>Ë´ãÈÅ∏ÊìáÈÇÄÁ¥Ñ‰∫∫Âì°‰∏¶Â°´ÂØ´Ê∞ëÁúæË≥áÊñô</p>
            <div class="network-status" id="networkStatus" title="Á∂≤Ë∑ØÁãÄÊÖã"></div>
        </div>
        
        <!-- PWA ÂÆâË£ùÊèêÁ§∫ -->
        <div class="pwa-install-prompt" id="pwaInstallPrompt" style="display: none;">
            <div class="install-prompt-content">
                <span>üì± ÂèØ‰ª•ÂÆâË£ùÊ≠§ÊáâÁî®Á®ãÂºèÂà∞ÊÇ®ÁöÑË£ùÁΩÆ</span>
                <button class="btn-install" id="installBtn">ÂÆâË£ù</button>
                <button class="btn-dismiss" id="dismissBtn">√ó</button>
            </div>
        </div>
        
        <!-- ÂêåÊ≠•ÁãÄÊÖãÊèêÁ§∫ -->
        <div class="sync-status" id="syncStatus"></div>
        
        <!-- ÁôªÂÖ•/ÈÅ∏Êìá‰∫∫Âì°ÂçÄÂ°ä -->
        <div class="login-section">
            <div class="user-info" id="userInfo">
                <div>
                    <div class="user-name">Ë´ãÈÅ∏ÊìáÈÇÄÁ¥Ñ‰∫∫Âì°</div>
                </div>
            </div>
            
            <div class="login-form" id="loginForm">
                <select id="staffSelect" required>
                    <option value="">ÈÅ∏ÊìáÈÇÄÁ¥Ñ‰∫∫Âì°</option>
                </select>
                <input type="password" id="staffPassword" placeholder="ÂØÜÁ¢º(Â¶ÇÊúâ)" maxlength="20">
                <button type="button" class="btn btn-secondary" onclick="login()">ÁôªÂÖ•</button>
            </div>
            
            <div class="quota-info" id="quotaInfo" style="display: none;">
                <div class="quota-item">
                    <div class="quota-number" id="todayCount">0</div>
                    <div class="quota-label">‰ªäÊó•Â∑≤ÈÇÄÁ¥Ñ(‰∏ªÁ¥Ñ)</div>
                </div>
                <div class="quota-item">
                    <div class="quota-number" id="todayLimit">0</div>
                    <div class="quota-label">‰ªäÊó•Á∏ΩÈôêÈ°ç</div>
                </div>
                <div class="quota-item">
                    <div class="quota-number" id="remainingCount">0</div>
                    <div class="quota-label">Ââ©È§òÈ°çÂ∫¶</div>
                </div>
            </div>
            
            <div class="session-quotas" id="sessionQuotas" style="display: none;">
                <div class="session-quota morning" id="morningQuota">
                    <div class="quota-label">Êó©‰∏äÂ†¥(‰∏ªÁ¥Ñ)</div>
                    <div><span id="morningCount">0</span>/<span id="morningLimit">0</span></div>
                </div>
                <div class="session-quota afternoon" id="afternoonQuota">
                    <div class="quota-label">‰∏ãÂçàÂ†¥(‰∏ªÁ¥Ñ)</div>
                    <div><span id="afternoonCount">0</span>/<span id="afternoonLimit">0</span></div>
                </div>
                <div class="session-quota evening" id="eveningQuota">
                    <div class="quota-label">Êôö‰∏äÂ†¥(‰∏ªÁ¥Ñ)</div>
                    <div><span id="eveningCount">0</span>/<span id="eveningLimit">0</span></div>
                </div>
            </div>
        </div>
        
        <!-- ÂäüËÉΩÈÅ∏ÊìáÂçÄÂ°ä -->
        <div class="function-tabs" id="functionTabs" style="display: none;">
            <button class="tab-btn active" onclick="switchFunction('invite')">Êñ∞Â¢ûÈÇÄÁ¥Ñ</button>
            <button class="tab-btn" onclick="switchFunction('list')">‰ªäÊó•ÈÇÄÁ¥Ñ</button>
        </div>
        
        <div class="main-content" id="mainContent" style="display: none;">
            <div class="alert" id="alertMessage"></div>
            
            <!-- Êñ∞Â¢ûÈÇÄÁ¥ÑË°®ÂñÆ -->
            <div id="inviteSection">
                <div class="quota-warning" id="quotaWarning"></div>
                <form id="invitationForm">
                    <!-- ÂÄã‰∫∫Ë≥áË®ä -->
                    <div class="form-section">
                        <div class="section-title">ÂÄã‰∫∫Ë≥áË®ä</div>
                        
                        <div class="form-group">
                            <label for="name">ÂßìÂêç *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        
                        <div class="phone-group">
                            <div class="form-group">
                                <label for="phone1">ÈõªË©±ËôüÁ¢º1 *</label>
                                <input type="tel" id="phone1" name="phone1" required>
                            </div>
                            <div class="form-group">
                                <label for="phone2">ÈõªË©±ËôüÁ¢º2</label>
                                <input type="tel" id="phone2" name="phone2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂÇôË®ª -->
                    <div class="form-section">
                        <div class="section-title">ÂÇôË®ª</div>
                        <div class="form-group">
                            <textarea id="notes" name="notes" rows="2" placeholder="Ëº∏ÂÖ•ÂÇôË®ªË≥áË®ä..."></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">Êèê‰∫§ÈÇÄÁ¥ÑË≥áÊñô</button>
                    <div class="submit-status" id="submitStatus"></div>
                </form>
            </div>
            
            <!-- ‰ªäÊó•ÈÇÄÁ¥ÑÂêçÂñÆ -->
            <div id="listSection" style="display: none;">
                <div class="form-section">
                    <div class="section-title">‰ªäÊó•ÈÇÄÁ¥ÑÂêçÂñÆ</div>
                    
                    <!-- Êú¨Âú∞Áµ±Ë®àË≥áË®ä -->
                    <div class="local-stats" id="localStats">
                        <div class="stats-row">
                            <span>Êú¨Âú∞ÈÇÄÁ¥ÑÊï∏Èáè:</span>
                            <span id="localCount">0</span>
                        </div>
                        <div class="stats-row">
                            <span>ÂæÖÂêåÊ≠•:</span>
                            <span id="pendingCount">0</span>
                        </div>
                        <div class="stats-row">
                            <span>Â∑≤ÂêåÊ≠•:</span>
                            <span id="syncedCount">0</span>
                        </div>
                    </div>
                    
                    <!-- ÂêåÊ≠•ÊéßÂà∂ÊåâÈàï -->
                    <div class="sync-controls">
                        <button class="btn btn-sync" id="syncBtn" onclick="manualSync()">
                            <span id="syncBtnText">ÂêåÊ≠•Ëá≥Èõ≤Á´Ø</span>
                        </button>
                        <button class="btn btn-secondary" onclick="refreshInvitationList()">ÈáçÊñ∞Êï¥ÁêÜ</button>
                    </div>
                    
                    <div class="invitation-list" id="invitationList">
                        <div class="no-data">ËºâÂÖ•‰∏≠...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Á∑®ËºØÊ®°ÊÖãÊ°Ü -->
        <div class="edit-modal" id="editModal">
            <div class="edit-modal-content">
                <div class="modal-header">
                    <div class="modal-title">Á∑®ËºØÈÇÄÁ¥ÑË≥áÊñô</div>
                    <button class="modal-close" onclick="closeEditModal()">&times;</button>
                </div>
                
                <form id="editForm">
                    <input type="hidden" id="editId" name="editId">
                    
                    <!-- ÂÄã‰∫∫Ë≥áË®ä -->
                    <div class="form-section">
                        <div class="section-title">ÂÄã‰∫∫Ë≥áË®ä</div>
                        
                        <div class="form-group">
                            <label for="editName">ÂßìÂêç *</label>
                            <input type="text" id="editName" name="editName" required>
                        </div>
                        
                        <div class="phone-group">
                            <div class="form-group">
                                <label for="editPhone1">ÈõªË©±ËôüÁ¢º1 *</label>
                                <input type="tel" id="editPhone1" name="editPhone1" required>
                            </div>
                            <div class="form-group">
                                <label for="editPhone2">ÈõªË©±ËôüÁ¢º2</label>
                                <input type="tel" id="editPhone2" name="editPhone2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÂÅ•Ê™¢È†ÖÁõÆ -->
                    <div class="form-section">
                        <div class="section-title">ÂÅ•Ê™¢È†ÖÁõÆ</div>
                        <div class="health-checks">
                            <div class="checkbox-item" onclick="toggleEditCheckbox('editMammography')">
                                <input type="checkbox" id="editMammography" name="editMammography" value="1">
                                <label for="editMammography">‰π≥Êîù</label>
                            </div>
                            <div class="checkbox-item" onclick="toggleEditCheckbox('editFirstScreen')">
                                <input type="checkbox" id="editFirstScreen" name="editFirstScreen" value="1">
                                <label for="editFirstScreen">È¶ñÁØ©</label>
                            </div>
                            <div class="checkbox-item" onclick="toggleEditCheckbox('editCervicalSmear')">
                                <input type="checkbox" id="editCervicalSmear" name="editCervicalSmear" value="1">
                                <label for="editCervicalSmear">Â≠êÊäπ</label>
                            </div>
                            <div class="checkbox-item" onclick="toggleEditCheckbox('editAdultHealth')">
                                <input type="checkbox" id="editAdultHealth" name="editAdultHealth" value="1">
                                <label for="editAdultHealth">ÊàêÂÅ•</label>
                            </div>
                            <div class="checkbox-item" onclick="toggleEditCheckbox('editHepatitis')">
                                <input type="checkbox" id="editHepatitis" name="editHepatitis" value="1">
                                <label for="editHepatitis">BCËÇùÁÇé</label>
                            </div>
                            <div class="checkbox-item" onclick="toggleEditCheckbox('editColorectal')">
                                <input type="checkbox" id="editColorectal" name="editColorectal" value="1">
                                <label for="editColorectal">Â§ßËÖ∏</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Â†¥Ê¨°Ë≥áË®ä -->
                    <div class="form-section">
                        <div class="section-title">Â†¥Ê¨°Ë≥áË®ä</div>
                        
                        <div class="form-group">
                            <label for="editSessionInfo">ÈÅ∏ÊìáÂ†¥Ê¨° *</label>
                            <select id="editSessionInfo" name="editSessionInfo" required>
                                <option value="">ËºâÂÖ•‰∏≠...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editSession">ÊôÇÊÆµ *</label>
                            <select id="editSession" name="editSession" required>
                                <option value="">ÈÅ∏ÊìáÊôÇÊÆµ</option>
                                <option value="Êó©‰∏äÂ†¥">Êó©‰∏äÂ†¥</option>
                                <option value="‰∏ãÂçàÂ†¥">‰∏ãÂçàÂ†¥</option>
                                <option value="Êôö‰∏äÂ†¥">Êôö‰∏äÂ†¥</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ÂÇôË®ª -->
                    <div class="form-section">
                        <div class="section-title">ÂÇôË®ª</div>
                        <div class="form-group">
                            <textarea id="editNotes" name="editNotes" rows="2" placeholder="Ëº∏ÂÖ•ÂÇôË®ªË≥áË®ä..."></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button type="submit" class="btn" style="flex: 1;">Êõ¥Êñ∞Ë≥áÊñô</button>
                        <button type="button" class="btn" onclick="closeEditModal()" style="flex: 1;">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- PWA ÂÆâË£ùÂíå Service Worker Ë®ªÂÜäËÖ≥Êú¨ -->
    <script>
        // Service Worker Ë®ªÂÜä
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/invitation-app/sw.js')
                    .then(registration => {
                        console.log('Service Worker Ë®ªÂÜäÊàêÂäü:', registration);
                        
                        // Ê™¢Êü•ÊòØÂê¶ÊúâÊõ¥Êñ∞
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // ÊúâÊñ∞ÁâàÊú¨ÂèØÁî®
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker Ë®ªÂÜäÂ§±Êïó:', error);
                    });
                
                // Áõ£ËÅΩ‰æÜËá™ Service Worker ÁöÑË®äÊÅØ
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'BACKGROUND_SYNC') {
                        // ËôïÁêÜËÉåÊôØÂêåÊ≠•Ë´ãÊ±Ç
                        if (typeof autoSync === 'function') {
                            autoSync();
                        }
                    }
                });
            });
        }
        
        // PWA ÂÆâË£ùÊèêÁ§∫
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Èò≤Ê≠¢È†êË®≠ÁöÑÂÆâË£ùÊèêÁ§∫
            e.preventDefault();
            deferredPrompt = e;
            
            // È°ØÁ§∫Ëá™Ë®ÇÂÆâË£ùÊèêÁ§∫
            const installPrompt = document.getElementById('pwaInstallPrompt');
            installPrompt.style.display = 'block';
        });
        
        document.getElementById('installBtn').addEventListener('click', () => {
            const installPrompt = document.getElementById('pwaInstallPrompt');
            installPrompt.style.display = 'none';
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Áî®Êà∂Êé•Âèó‰∫ÜÂÆâË£ùÊèêÁ§∫');
                    }
                    deferredPrompt = null;
                });
            }
        });
        
        document.getElementById('dismissBtn').addEventListener('click', () => {
            const installPrompt = document.getElementById('pwaInstallPrompt');
            installPrompt.style.display = 'none';
            deferredPrompt = null;
        });
        
        // Ê™¢Ê∏¨ PWA ÊòØÂê¶Â∑≤ÂÆâË£ù
        window.addEventListener('appinstalled', () => {
            console.log('PWA Â∑≤ÂÆâË£ù');
            const installPrompt = document.getElementById('pwaInstallPrompt');
            installPrompt.style.display = 'none';
        });
        
        // È°ØÁ§∫Êõ¥Êñ∞ÈÄöÁü•
        function showUpdateNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ÂÅ•Ê™¢ÈÇÄÁ¥ÑÁ≥ªÁµ±', {
                    body: 'ÊúâÊñ∞ÁâàÊú¨ÂèØÁî®ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢‰ª•Êõ¥Êñ∞',
                    icon: '/icons/icon-192.png'
                });
            } else {
                showSyncStatus('ÊúâÊñ∞ÁâàÊú¨ÂèØÁî®ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢', 'info');
            }
        }
        
        // Ë´ãÊ±ÇÈÄöÁü•Ê¨äÈôê
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // ËôïÁêÜ URL ÂèÉÊï∏ÔºàÊîØÊè¥Âø´Êç∑ÊñπÂºèÔºâ
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        if (tab && typeof switchFunction === 'function') {
            // Á≠âÂæÖÈ†ÅÈù¢ÂÆåÂÖ®ËºâÂÖ•ÂæåÂàáÊèõ
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (currentUser) { // Á¢∫‰øùÂ∑≤ÁôªÂÖ•
                        switchFunction(tab);
                    }
                }, 1000);
            });
        }
    </script>
</body>
</html>